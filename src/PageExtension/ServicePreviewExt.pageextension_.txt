
pageextension 80041 "DAF ServicePreviewExt" extends "Service Preview"
//NOTE: Send Service Preview by e-mail
{
    actions
    {
        addlast(Processing)
        {
            action("DAF SendServicePreviewEmail")
            {
                ApplicationArea = All;
                Caption = 'Send Service Preview Email';
                Image = Email;
                trigger OnAction()
                var
                    ServicePreviewLineRec: Record "Service Preview Line";
                    ServiceHdrRec: Record "Service Header";
                    Customer: Record Customer;
                begin
                    ServicePreviewLineRec := Rec;

                    // Get Service Header from the line record
                    if not ServiceHdrRec.Get(ServicePreviewLineRec."Document Type", ServicePreviewLineRec."Document No.") then begin
                        Message('Service Header record not found.');
                        exit;
                    end;

                    // Validate Customer Email
                    if not Customer.Get(ServiceHdrRec."Bill-to Customer No.") then begin
                        Message('Customer not found.');
                        exit;
                    end;
                    if Customer."E-Mail" = '' then begin
                        Message('Customer does not have an email address.');
                        exit;
                    end;

                    // Call email sending procedure passing Service Header record
                    SendServicePreviewEmail(ServiceHdrRec, Customer."E-Mail");
                end;
            }
        }
    }

    local procedure SendServicePreviewEmail(ServiceHdrRec: Record 5025624; MailAddress: Text)
    var
        CU_SMTPMail: Codeunit "SMTP Mail";
        CU_FileManagement: Codeunit "File Management";
        G_CVMAddOnSetup: Record "CVM Add-on Setup";
        G_CompanyInformation: Record "Company Information";
        ReportSelection: Record "Service Manag. Rep. Selection";
        ReportId: Integer;
        FilePath: Text;
        FileName: Text;
        MailText: Text;
        TempFileName: Text;
    begin
        if StrLen(MailAddress) = 0 then
            exit;

        if not G_CVMAddOnSetup.Get() then begin
            Message('CVM Add-on Setup not found.');
            exit;
        end;

        if not G_CompanyInformation.Get() then begin
            Message('Company Information not found.');
            exit;
        end;

        // Get report ID for usage 'Service Preview'
        ReportSelection.SetRange(Usage, 19);
        if not ReportSelection.FindFirst() then begin
            Message('No report layout found for usage "Service Preview".');
            exit;
        end;
        ReportId := ReportSelection."Report ID";

        // Get file path from setup
        FilePath := G_CVMAddOnSetup."Doc. Path batch PDF invoices";
        if (CopyStr(FilePath, StrLen(FilePath), 1) <> '\') then
            FilePath += '\';

        // Compose file name using Service Header No.
        FileName := StrSubstNo('ServicePreview_%1_%2.pdf', ServiceHdrRec."No.", Format(Today(), 0, '<Year4><Month,2><Day,2>'));

        TempFileName := FilePath + FileName;

        // Save report as PDF passing Service Header record
        Report.SaveAsPDF(ReportId, TempFileName, ServiceHdrRec);

        if CU_FileManagement.ServerFileExists(TempFileName) then begin
            MailText := 'Dear customer,<br /><br />Please find attached the Service Preview report for your reference.<br /><br />Best regards,<br />' + G_CompanyInformation.Name;

            CU_SMTPMail.CreateMessage(G_CompanyInformation.Name, '', MailAddress, 'Service Preview Report - ' + ServiceHdrRec."No.", MailText, true);
            CU_SMTPMail.AddAttachment(TempFileName, FileName);
            CU_SMTPMail.Send();

            File.Erase(TempFileName);

            Message('Service Preview report sent to %1.', MailAddress);
        end else
            Message('Failed to generate the PDF report file.');
    end;
}